"use strict";angular.module("menuDuJourApp",["menuDuJourFilters","ui.date","ui.bootstrap","http-auth-interceptor"]).config(["$routeProvider",function(e){var t=new Date;e.when("/menus/create/:year/:month/:day",{templateUrl:"views/menuCreate.html",controller:"MenuCreateCtrl"}).when("/menus/view/:year/:month/:day",{templateUrl:"views/menus.html",controller:"MenuViewCtrl"}).when("/plats/create",{templateUrl:"views/platCreate.html",controller:"PlatCreateCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/logout",{templateUrl:"views/logout.html",controller:"LogoutCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).otherwise({redirectTo:"/menus/view/"+t.getFullYear()+"/"+(parseInt(t.getMonth(),10)+1)+"/"+t.getDate()})}]),angular.module("menuDuJourApp").controller("MenuCreateCtrl",["$scope","$rootScope","$routeParams","$http","$dialog","$location","$log",function(e,t,n,o,r,l,u){var a=new Date(n.year,n.month-1,n.day);u.log("Parsing date from URL : "+a),u.log("on appel l'url /api/menu/"+a.getFullYear()+"/"+a.getMonth()+"/"+a.getDate()),o.get("/api/menu/"+a.getFullYear()+"/"+a.getMonth()+"/"+a.getDate()).success(function(t){u.log("succes de l'appel : /api/menu/"+a.getFullYear()+"/"+a.getMonth()+"/"+a.getDate()),e.dateOptions={dateFormat:"dd/mm/yy"},u.log("le menu est le suivant : "+JSON.stringify(t)),e.menu=t,u.log("on récupère lintégralité des plats non inclus dans le menu {id : "+e.menu._id+"}"),o.get("/api/menu/"+e.menu._id+"/plats-non-inclus").success(function(t){u.log("succes de l'appel /api/menu/"+e.menu._id+"/plats-non-inclus"),e.plats=t,u.log("les plats non inclus pour le menu {id : "+e.menu._id+"} sont : "+JSON.stringify(t))})}),t.$on("event:auth-loginRequired",function(){l.path("/login")}),e.addPlat=function(t){o.put("/api/menu/"+e.menu._id+"/add/"+t._id).success(function(n){u.log("ajout du plat : "+t+" au menu"),e.menu.plats.push(t),u.log("suppression du plat : "+t+" de la liste des plats non inclus"),e.plats.splice(e.plats.indexOf(t),1),console.log(n)})},e.createPlat=function(t){e.opts={backdrop:!0,keyboard:!0,backdropClick:!0,templateUrl:"/views/platCreate.html",controller:"PlatCreateCtrl",resolve:{name:function(){return angular.copy(t)}}};var n=r.dialog(e.opts);n.open().then(function(){o.get("/api/menu/"+e.menu._id+"/plats-non-inclus").success(function(t){u.log("mise à jour de la liste des plats non inclus : "+JSON.stringify(t)),e.plats=t})})},e.removePlat=function(t){o.delete("/api/menu/"+e.menu._id+"/remove/"+t._id).success(function(){u.log("suppression du plat : "+JSON.stringify(t)),u.log("ajout du plat : "+JSON.stringify(t)+" à la liste des plats non inclus"),e.plats.push(t),u.log("suppression du plat : "+JSON.stringify(t)+" du menu"),e.menu.plats.splice(e.menu.plats.indexOf(t),1)})},e.changeDate=function(){var t=new Date(e.menu.date);u.log("changement de la date : "+t),u.log("on va à l'url : /menus/create/"+t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate()),l.path("/menus/create/"+t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate())}}]).controller("MenuViewCtrl",["$scope","$routeParams","$http","$log","$location",function(e,t,n,o,r){e.date=new Date(t.year,t.month-1,t.day),n.get("/api/menu/"+e.date.getFullYear()+"/"+e.date.getMonth()+"/"+e.date.getDate()).success(function(t){e.menu=t,o.log("affichage du menu : "+JSON.stringify(e.menu))}),e.editMenu=function(){r.path("/menus/create/"+e.date.getFullYear()+"/"+(e.date.getMonth()+1)+"/"+e.date.getDate())},e.previousDate=function(){var t=new Date(e.date);t.setDate(t.getDate()-1),r.path("/menus/view/"+t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate())},e.nextDate=function(){var t=new Date(e.date);t.setDate(t.getDate()+1),r.path("/menus/view/"+t.getFullYear()+"/"+(t.getMonth()+1)+"/"+t.getDate())}}]),angular.module("menuDuJourApp").controller("PlatCreateCtrl",["$scope","$routeParams","$http","dialog","name","$log",function(e,t,n,o,r,l){e.plat={name:r},e.close=function(){o.close()},n.get("/api/type").success(function(t){e.types=t}),e.create=function(){n.put("/api/plat",e.plat).success(function(){l.log("création du plat : "+JSON.stringify(e.plat)),o.close()})}}]),angular.module("menuDuJourApp").controller("LoginCtrl",["$scope","$window","$location","$http","$log","authService",function(e,t,n,o,r,l){e.master={},e.loginErrorMessage="",e.authentification=function(){o.post("/auth/login",{username:e.user.name,password:e.user.password}).success(function(){e.loginErrorMessage="",r.log("authentification réussi"),l.loginConfirmed(),t.history.back()}).error(function(t){e.loginErrorMessage=t.error,e.reset(),r.log(e.loginErrorMessage)})},e.reset=function(){e.user=angular.copy(e.master)}}]).controller("LogoutCtrl",["$scope","$window","$location","$http","$log",function(e,t,n,o,r){o.get("/auth/logout").success(function(){r.log("déconnexion réussi"),n.path("/")}).error(function(e,t,n,o){r.log(JSON.stringify(e)),r.log(JSON.stringify(t)),r.log(JSON.stringify(n)),r.log(JSON.stringify(o))})}]),angular.module("menuDuJourFilters",[]).filter("highlight",function(){return function(e,t,n){return t||angular.isNumber(t)?(e=""+e,t=""+t,n?e.split(t).join("<b>"+t+"</b>"):e.replace(RegExp(t,"gi"),"<b>$&</b>")):e}}),function(){angular.module("http-auth-interceptor",["http-auth-interceptor-buffer"]).factory("authService",["$rootScope","httpBuffer",function(e,t){return{loginConfirmed:function(n){e.$broadcast("event:auth-loginConfirmed",n),t.retryAll()}}}]).config(["$httpProvider",function(e){var t=["$rootScope","$q","httpBuffer",function(e,t,n){function o(e){return e}function r(o){if(401===o.status&&!o.config.ignoreAuthModule){var r=t.defer();return n.append(o.config,r),e.$broadcast("event:auth-loginRequired"),r.promise}return t.reject(o)}return function(e){return e.then(o,r)}}];e.responseInterceptors.push(t)}]),angular.module("http-auth-interceptor-buffer",[]).factory("httpBuffer",["$injector",function(e){function t(t,o){function r(e){o.resolve(e)}function l(e){o.reject(e)}n=n||e.get("$http"),n(t).then(r,l)}var n,o=[];return{append:function(e,t){o.push({config:e,deferred:t})},retryAll:function(){for(var e=0;o.length>e;++e)t(o[e].config,o[e].deferred);o=[]}}}])}(),angular.module("menuDuJourApp").controller("UsersCtrl",["$scope","$http","$log",function(e,t,n){e.loadRoles=function(){t.get("/api/role").success(function(t){n.log("succes de l'appel : /api/role"),n.log("les roles sont : "+JSON.stringify(t)),e.roles=t})},e.loadUsers=function(){t.get("/api/user").success(function(t){n.log("succes de l'appel : /api/user"),n.log("les utilistateurs sont : "+JSON.stringify(t)),e.users=t,e.selectRole={};for(var o=0;e.users.length>o;o++)e.selectRole[e.users[o]._id]=e.users[o].role._id})},e.updateUser=function(o,r){t.post("/api/user/"+o+"/role/"+r).success(function(){n.log("succes de l'appel : api/user/"+o+"/role/"+r),e.loadUsers()})},e.addUser=function(){t.put("/api/user",{name:e.newUser.name,role:{_id:e.newUser.role}}).success(function(){n.log("succes de l'ajout de l'utilisateur : "+e.newUser.name),e.loadUsers()})},e.deleteUser=function(o){t.delete("/api/user/"+o).success(function(){n.log("succes de la suppression de l'utilisateur : "+o),e.loadUsers()})},e.loadUsers(),e.loadRoles()}]);